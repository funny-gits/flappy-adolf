<!-- FILE: index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <title>Jetpack Run</title>

  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(20, 26, 34, 0.92);
      --panel-2: rgba(20, 26, 34, 0.75);
      --text: #e9eef5;
      --muted: #aeb9c6;
      --accent: #8de0b4;
      --danger: #ff6b6b;
      --stroke: rgba(255,255,255,0.14);
      --shadow: rgba(0,0,0,0.45);
      --btn: rgba(255,255,255,0.08);
      --btnHover: rgba(255,255,255,0.13);

      --canvas-max-width: 960px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 50% 0%, #121a24 0%, var(--bg) 60%, #070a0e 100%);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .app{
      width: min(980px, 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    header{
      width: min(980px, 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      opacity: 0.95;
    }

    .brand{
      display: flex;
      flex-direction: column;
      line-height: 1.15;
    }
    .brand strong{ font-size: 16px; letter-spacing: 0.06em; text-transform: uppercase; }
    .brand span{ font-size: 12px; color: var(--muted); }

    .hint{
      font-size: 12px;
      color: var(--muted);
      text-align: right;
    }

    #game-container{
      width: 100%;
      max-width: var(--canvas-max-width);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 14px 42px var(--shadow);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.2);
      position: relative;
    }

    .row{
      width: min(980px, 100%);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .btn{
      border: 1px solid var(--stroke);
      background: var(--btn);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.06s ease, background 0.12s ease, border-color 0.12s ease;
      user-select: none;
    }
    .btn:hover{ background: var(--btnHover); border-color: rgba(255,255,255,0.22); }
    .btn:active{ transform: translateY(1px) scale(0.99); }
    .btn.primary{ border-color: rgba(141,224,180,0.35); }
    .btn.danger{ border-color: rgba(255,107,107,0.35); }
    .btn.ghost{ background: transparent; }

    /* Modals */
    .modal-overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0,0,0,0.62);
      z-index: 50;
    }
    .modal{
      width: min(560px, 100%);
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: 0 16px 48px var(--shadow);
      padding: 18px;
    }
    .modal h2{
      margin: 0 0 8px 0;
      font-size: 18px;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .modal p{ margin: 0 0 14px 0; color: var(--muted); font-size: 14px; }
    .modal .actions{ display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 12px; }

    /* Scores list */
    #highScoresList{
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 320px;
      overflow: auto;
    }
    #highScoresList li{
      display: grid;
      grid-template-columns: 42px 1fr 80px 140px;
      gap: 10px;
      align-items: center;
      background: var(--panel-2);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
    }
    #highScoresList .rank{ color: var(--muted); font-weight: 700; }
    #highScoresList .player-name{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    #highScoresList .score-value{ text-align: right; color: var(--accent); font-weight: 800; }
    #highScoresList .score-date{ text-align: right; color: var(--muted); font-size: 12px; white-space: nowrap; }

    /* Name input */
    #nameInputField{
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    #nameInputField:focus{
      border-color: rgba(141,224,180,0.35);
      box-shadow: 0 0 0 4px rgba(141,224,180,0.10);
    }

    /* In-game touch controls */
    #in-game-controls{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      width: min(980px, 100%);
      max-width: var(--canvas-max-width);
      display: none;
      justify-content: space-between;
      padding: 0 12px;
      pointer-events: none;
      z-index: 40;
    }
    #in-game-controls button{
      pointer-events: auto;
      width: 82px;
      height: 82px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.35);
      color: var(--text);
      font-size: 14px;
      font-weight: 800;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      backdrop-filter: blur(2px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      transition: transform 0.08s ease, background 0.12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    #in-game-controls button:active{
      transform: scale(0.95);
      background: rgba(0,0,0,0.52);
    }
    #jumpButton{ border-color: rgba(141,224,180,0.28); }
    #shootButton{ border-color: rgba(255,255,255,0.16); }

    /* Small screens */
    @media (max-width: 520px){
      header{ gap: 8px; }
      .hint{ display: none; }
      #highScoresList li{ grid-template-columns: 34px 1fr 64px; }
      #highScoresList .score-date{ display: none; }
      #in-game-controls button{ width: 74px; height: 74px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <strong>Jetpack Run</strong>
        <span>Hold SPACE (or Jump) to thrust • Avoid obstacles • Grab coins</span>
      </div>
      <div class="hint">Tip: Hard refresh if you just pushed updates</div>
    </header>

    <div id="game-container" class="relative"></div>

    <div id="main-menu-buttons" class="row" style="display:none;">
      <button id="startButton" class="btn primary">Start</button>
      <button id="viewScoresButton" class="btn">Records</button>
      <button id="nameButton" class="btn ghost">Codename</button>
    </div>

    <div id="game-over-buttons" class="row" style="display:none;">
      <button id="retryButton" class="btn primary">Retry</button>
      <button id="mainMenuButtonFromGameOver" class="btn">Main Menu</button>
      <button id="viewScoresButtonFromGameOver" class="btn">Records</button>
    </div>

    <!-- Scoreboard Modal -->
    <div id="scoreboard" class="modal-overlay" style="display:none;">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="scores-title">
        <h2 id="scores-title">Records</h2>
        <p>Top runs saved on this device.</p>
        <ul id="highScoresList"></ul>
        <div class="actions">
          <button id="closeScoreboardButton" class="btn danger">Close</button>
        </div>
      </div>
    </div>

    <!-- Name Modal -->
    <div id="playerNameInput" class="modal-overlay" style="display:none;">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="name-title">
        <h2 id="name-title">Codename</h2>
        <p>Used for local records. Max 15 characters.</p>
        <input id="nameInputField" type="text" maxlength="15" placeholder="Your codename" />
        <div class="actions">
          <button id="saveNameButton" class="btn primary">Save</button>
          <button id="deleteNameButton" class="btn danger" style="display:none;">Delete</button>
          <button id="closeNameButton" class="btn">Close</button>
        </div>
      </div>
    </div>

    <!-- In-game touch controls -->
    <div id="in-game-controls">
      <button id="jumpButton">Jump</button>
      <button id="shootButton">Shoot</button>
    </div>
  </div>

  <!-- p5 must load BEFORE main.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.4/lib/addons/p5.sound.min.js"></script>

  <!-- Cache-bust main.js to avoid GH Pages stale caching -->
  <script type="module" src="./main.js?v=2025-12-18-2"></script>

  <script>
    // --- UI element refs ---
    const startButton = document.getElementById('startButton');
    const viewScoresButton = document.getElementById('viewScoresButton');
    const retryButton = document.getElementById('retryButton');
    const mainMenuButtonFromGameOver = document.getElementById('mainMenuButtonFromGameOver');
    const viewScoresButtonFromGameOver = document.getElementById('viewScoresButtonFromGameOver');
    const nameButton = document.getElementById('nameButton');

    const mainMenuButtonsDiv = document.getElementById('main-menu-buttons');
    const gameOverButtonsDiv = document.getElementById('game-over-buttons');

    const scoreboardModal = document.getElementById('scoreboard');
    const closeScoreboardButton = document.getElementById('closeScoreboardButton');

    const playerNameInputModal = document.getElementById('playerNameInput');
    const nameInputField = document.getElementById('nameInputField');
    const saveNameButton = document.getElementById('saveNameButton');
    const deleteNameButton = document.getElementById('deleteNameButton');
    const closeNameButton = document.getElementById('closeNameButton');

    const inGameControlsDiv = document.getElementById('in-game-controls');
    const jumpButton = document.getElementById('jumpButton');
    const shootButton = document.getElementById('shootButton');

    // Default screen if main.js hasn't set it yet
    if (!window.currentScreen) window.currentScreen = "START";

    // --- UI visibility API expected by main.js ---
    window.showMainMenuButtons = function(show){
      mainMenuButtonsDiv.style.display = show ? 'flex' : 'none';
    };

    window.showGameOverButtons = function(show){
      gameOverButtonsDiv.style.display = show ? 'flex' : 'none';
    };

    window.showInGameControls = function(show){
      inGameControlsDiv.style.display = show ? 'flex' : 'none';
    };

    window.showScoreboard = function(show){
      scoreboardModal.style.display = show ? 'flex' : 'none';
      if (show && typeof window.displayHighScores === 'function') {
        window.displayHighScores();
      }
      if (show) window.currentScreen = "SCOREBOARD";
    };

    window.showNameInput = function(show){
      playerNameInputModal.style.display = show ? 'flex' : 'none';
      if (show) {
        nameInputField.value = window.playerName || "Recruit";
        nameInputField.focus();
        // show delete only if a custom name exists
        const n = (window.playerName || "").trim();
        deleteNameButton.style.display = (n && n !== "Recruit" && n !== "Player") ? 'inline-block' : 'none';
      }
    };

    // --- Button actions ---
    startButton.addEventListener('click', () => {
      if (window.currentScreen === "START") {
        window.currentScreen = "GAME";
        window.resetGameValues?.();
        window.showMainMenuButtons(false);
        window.showGameOverButtons(false);
      }
      startButton.blur();
    });

    retryButton.addEventListener('click', () => {
      if (window.currentScreen === "GAME_OVER") {
        window.currentScreen = "GAME";
        window.resetGameValues?.();
      }
      retryButton.blur();
    });

    mainMenuButtonFromGameOver.addEventListener('click', () => {
      window.currentScreen = "START";
      window.resetGameValues?.();
      window.showScoreboard(false);
      window.showNameInput(false);
      mainMenuButtonFromGameOver.blur();
    });

    viewScoresButton.addEventListener('click', () => {
      if (window.currentScreen === "START") window.showScoreboard(true);
      viewScoresButton.blur();
    });

    viewScoresButtonFromGameOver.addEventListener('click', () => {
      window.showScoreboard(true);
      viewScoresButtonFromGameOver.blur();
    });

    closeScoreboardButton.addEventListener('click', () => {
      window.showScoreboard(false);
      if (window.currentScreen === "SCOREBOARD") window.currentScreen = "START";
      closeScoreboardButton.blur();
    });

    nameButton.addEventListener('click', () => {
      window.showNameInput(true);
      nameButton.blur();
    });

    closeNameButton.addEventListener('click', () => {
      window.showNameInput(false);
      closeNameButton.blur();
    });

    saveNameButton.addEventListener('click', () => {
      const newName = (nameInputField.value || "").trim();
      if (!newName) {
        nameInputField.placeholder = "Codename cannot be empty";
        setTimeout(() => nameInputField.placeholder = "Your codename", 1600);
        return;
      }
      window.savePlayerName?.(newName);
      window.showNameInput(false);
      if (window.currentScreen === "START") window.showMainMenuButtons(true);
      saveNameButton.blur();
    });

    deleteNameButton.addEventListener('click', () => {
      window.deletePlayerName?.();
      nameInputField.value = window.playerName || "Recruit";
      deleteNameButton.style.display = 'none';
      deleteNameButton.blur();
    });

    nameInputField.addEventListener('keydown', (e) => {
      if (e.key === "Enter") saveNameButton.click();
      if (e.key === "Escape") closeNameButton.click();
    });

    // --- Touch/mouse in-game controls ---
    function startFlyingFromUI(){
      if (window.currentScreen === "GAME") {
        window.setPlayerFlyingState?.(true);
        window.triggerJumpSound?.();
      } else if (window.currentScreen === "START") {
        startButton.click();
        window.setPlayerFlyingState?.(true);
        window.triggerJumpSound?.();
      }
    }
    function stopFlyingFromUI(){
      if (window.currentScreen === "GAME") window.stopPlayerFlying?.();
    }

    jumpButton.addEventListener('touchstart', (e) => { e.preventDefault(); startFlyingFromUI(); }, { passive:false });
    jumpButton.addEventListener('touchend',   (e) => { e.preventDefault(); stopFlyingFromUI();  }, { passive:false });
    jumpButton.addEventListener('mousedown',  () => startFlyingFromUI());
    jumpButton.addEventListener('mouseup',    () => stopFlyingFromUI());
    jumpButton.addEventListener('mouseleave', () => stopFlyingFromUI());

    shootButton.addEventListener('touchstart', (e) => { e.preventDefault(); if (window.currentScreen === "GAME") window.triggerPlayerShoot?.(); }, { passive:false });
    shootButton.addEventListener('mousedown', () => { if (window.currentScreen === "GAME") window.triggerPlayerShoot?.(); });

    // Prevent page from scrolling on spacebar while playing/modals closed
    window.addEventListener('keydown', (e) => {
      if (e.key === " " && playerNameInputModal.style.display === "none" && scoreboardModal.style.display === "none") {
        e.preventDefault();
      }
    }, { passive:false });

    // Start screen buttons visible by default
    window.showMainMenuButtons(true);
  </script>
</body>
</html>
